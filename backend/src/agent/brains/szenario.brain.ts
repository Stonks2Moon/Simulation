import { Logger, LoggerService } from '@nestjs/common';
import { timer } from 'rxjs';
import { last, map, take, takeLast, takeWhile } from 'rxjs/operators';

import { PromiseOrValue } from '../../util.types';
import { MarketService, OperationType, OrderType } from '../../market/market.service';
import { Agent } from '../models/agent.model';
import { Brain } from '../models/brain.model';
import { addMinutes, addSeconds } from 'date-fns';

const testDATA = [
  {
    volume: 2500,
    delta: 0.07883842600000435,
    time: '2019-10-22 04:51:00',
  },
  {
    volume: 2500,
    delta: -0.07883842600000435,
    time: '2019-10-22 04:53:00',
  },
  {
    volume: 500,
    delta: -0.14782204799999477,
    time: '2019-10-22 04:56:00',
  },
  {
    volume: 1100,
    delta: -0.05912881900002276,
    time: '2019-10-22 05:06:00',
  },
  {
    volume: 600,
    delta: 0.6504170100000124,
    time: '2019-10-22 05:08:00',
  },
  {
    volume: 300,
    delta: -0.2168056700000136,
    time: '2019-10-22 06:48:00',
  },
  {
    volume: 1000,
    delta: -0.06898362199999042,
    time: '2019-10-22 07:07:00',
  },
  {
    volume: 300,
    delta: 0,
    time: '2019-10-22 07:10:00',
  },
  {
    volume: 400,
    delta: 0.06898362199999042,
    time: '2019-10-22 07:11:00',
  },
  {
    volume: 170,
    delta: 0.39419212800001446,
    time: '2019-10-22 07:12:00',
  },
  {
    volume: 1301,
    delta: -0.009854802999996082,
    time: '2019-10-22 08:01:00',
  },
  {
    volume: 1003,
    delta: 0.05912881899999434,
    time: '2019-10-22 08:03:00',
  },
  {
    volume: 1000,
    delta: 0.05912881899999434,
    time: '2019-10-22 08:15:00',
  },
  {
    volume: 2178,
    delta: 0.3252085050000062,
    time: '2019-10-22 08:17:00',
  },
  {
    volume: 100,
    delta: -0.09854803199999651,
    time: '2019-10-22 08:58:00',
  },
  {
    volume: 1674,
    delta: 0.09854803199999651,
    time: '2019-10-22 09:03:00',
  },
  {
    volume: 300,
    delta: -0.02956441000000609,
    time: '2019-10-22 09:14:00',
  },
  {
    volume: 200,
    delta: -0.11825763799998867,
    time: '2019-10-22 09:28:00',
  },
  {
    volume: 13026,
    delta: -0.049274015999998255,
    time: '2019-10-22 09:31:00',
  },
  {
    volume: 4600,
    delta: -0.019709606000020585,
    time: '2019-10-22 09:32:00',
  },
  {
    volume: 2356,
    delta: -0.009854802999996082,
    time: '2019-10-22 09:33:00',
  },
  {
    volume: 2493,
    delta: -0.05912881899999434,
    time: '2019-10-22 09:34:00',
  },
  {
    volume: 1890,
    delta: 0.07883842500001492,
    time: '2019-10-22 09:35:00',
  },
  {
    volume: 2751,
    delta: 0.014782204999988835,
    time: '2019-10-22 09:36:00',
  },
  {
    volume: 3579,
    delta: -0.08376582700000768,
    time: '2019-10-22 09:37:00',
  },
  {
    volume: 6750,
    delta: -0.05912881899999434,
    time: '2019-10-22 09:38:00',
  },
  {
    volume: 2080,
    delta: -0.14782204799999477,
    time: '2019-10-22 09:39:00',
  },
  {
    volume: 2058,
    delta: -0.03449181100000942,
    time: '2019-10-22 09:40:00',
  },
  {
    volume: 2542,
    delta: 0.009854802999996082,
    time: '2019-10-22 09:41:00',
  },
  {
    volume: 9615,
    delta: -0.034491810999981,
    time: '2019-10-22 09:42:00',
  },
  {
    volume: 6061,
    delta: -0.08869322900000043,
    time: '2019-10-22 09:43:00',
  },
  {
    volume: 3991,
    delta: -0.009854803000024503,
    time: '2019-10-22 09:44:00',
  },
  {
    volume: 1855,
    delta: -0.009854802999996082,
    time: '2019-10-22 09:45:00',
  },
  {
    volume: 2054,
    delta: -0.009854802999996082,
    time: '2019-10-22 09:46:00',
  },
  {
    volume: 4303,
    delta: 0.03941921200001275,
    time: '2019-10-22 09:47:00',
  },
  {
    volume: 1515,
    delta: 0.05912881899999434,
    time: '2019-10-22 09:48:00',
  },
  {
    volume: 4674,
    delta: -0.02463700800001334,
    time: '2019-10-22 09:49:00',
  },
  {
    volume: 1319,
    delta: 0.0936206310000216,
    time: '2019-10-22 09:50:00',
  },
  {
    volume: 5438,
    delta: -0.02956441000000609,
    time: '2019-10-22 09:51:00',
  },
  {
    volume: 4076,
    delta: 0.02956441000000609,
    time: '2019-10-22 09:52:00',
  },
  {
    volume: 3043,
    delta: 0.009854802999996082,
    time: '2019-10-22 09:53:00',
  },
  {
    volume: 5256,
    delta: -0.014782205000017257,
    time: '2019-10-22 09:54:00',
  },
  {
    volume: 5318,
    delta: 0.02463700800001334,
    time: '2019-10-22 09:55:00',
  },
  {
    volume: 1377,
    delta: 0.12811244099998476,
    time: '2019-10-22 09:56:00',
  },
  {
    volume: 7016,
    delta: 0.04927401600002668,
    time: '2019-10-22 09:57:00',
  },
  {
    volume: 3503,
    delta: -0.004927401000003329,
    time: '2019-10-22 09:58:00',
  },
  {
    volume: 2250,
    delta: -0.04434661500002335,
    time: '2019-10-22 09:59:00',
  },
  {
    volume: 3843,
    delta: -0.05912881899999434,
    time: '2019-10-22 10:00:00',
  },
  {
    volume: 8001,
    delta: 0.11825763900000652,
    time: '2019-10-22 10:01:00',
  },
  {
    volume: 2048,
    delta: -0.009854803999985506,
    time: '2019-10-22 10:02:00',
  },
  {
    volume: 3069,
    delta: -0.05912881900002276,
    time: '2019-10-22 10:03:00',
  },
  {
    volume: 643,
    delta: 0,
    time: '2019-10-22 10:04:00',
  },
  {
    volume: 4827,
    delta: -0.009854802999996082,
    time: '2019-10-22 10:05:00',
  },
  {
    volume: 1459,
    delta: 0.019709605999992164,
    time: '2019-10-22 10:06:00',
  },
  {
    volume: 2255,
    delta: 0.04927401600002668,
    time: '2019-10-22 10:07:00',
  },
  {
    volume: 1058,
    delta: -0.029564409000016667,
    time: '2019-10-22 10:08:00',
  },
  {
    volume: 1110,
    delta: 0.019709605999992164,
    time: '2019-10-22 10:09:00',
  },
  {
    volume: 2634,
    delta: 0.02463700800001334,
    time: '2019-10-22 10:10:00',
  },
  {
    volume: 3594,
    delta: 0.05420141799999101,
    time: '2019-10-22 10:11:00',
  },
  {
    volume: 3515,
    delta: 0.019709606000020585,
    time: '2019-10-22 10:12:00',
  },
  {
    volume: 5347,
    delta: -0.10840283500002101,
    time: '2019-10-22 10:13:00',
  },
  {
    volume: 3527,
    delta: 0.03941921300000217,
    time: '2019-10-22 10:14:00',
  },
  {
    volume: 2948,
    delta: 0.019709605999992164,
    time: '2019-10-22 10:15:00',
  },
  {
    volume: 3404,
    delta: -0.019709605999992164,
    time: '2019-10-22 10:16:00',
  },
  {
    volume: 4358,
    delta: 0.019709605999992164,
    time: '2019-10-22 10:17:00',
  },
  {
    volume: 2416,
    delta: -0.029564408999988245,
    time: '2019-10-22 10:18:00',
  },
  {
    volume: 698,
    delta: 0.029564408999988245,
    time: '2019-10-22 10:19:00',
  },
  {
    volume: 1534,
    delta: 0.01970960700001001,
    time: '2019-10-22 10:20:00',
  },
  {
    volume: 1273,
    delta: 0,
    time: '2019-10-22 10:21:00',
  },
  {
    volume: 1882,
    delta: -0.02956441000000609,
    time: '2019-10-22 10:22:00',
  },
  {
    volume: 2976,
    delta: 0.019709606000020585,
    time: '2019-10-22 10:23:00',
  },
  {
    volume: 2845,
    delta: -0.019709606000020585,
    time: '2019-10-22 10:24:00',
  },
  {
    volume: 4071,
    delta: -0.049274015999998255,
    time: '2019-10-22 10:25:00',
  },
  {
    volume: 2303,
    delta: 0.019709606000020585,
    time: '2019-10-22 10:26:00',
  },
  {
    volume: 689,
    delta: 0.07883842599997593,
    time: '2019-10-22 10:27:00',
  },
  {
    volume: 228,
    delta: -0.009854802999996082,
    time: '2019-10-22 10:28:00',
  },
  {
    volume: 1357,
    delta: 0.06898362200001884,
    time: '2019-10-22 10:29:00',
  },
  {
    volume: 2140,
    delta: -0.019709606000020585,
    time: '2019-10-22 10:30:00',
  },
  {
    volume: 3581,
    delta: 0.009854802999996082,
    time: '2019-10-22 10:31:00',
  },
  {
    volume: 1976,
    delta: -0.02956440999997767,
    time: '2019-10-22 10:32:00',
  },
  {
    volume: 2855,
    delta: 0.05420141799999101,
    time: '2019-10-22 10:33:00',
  },
  {
    volume: 5635,
    delta: -0.014782204999988835,
    time: '2019-10-22 10:34:00',
  },
  {
    volume: 2950,
    delta: 0.019709605999992164,
    time: '2019-10-22 10:35:00',
  },
  {
    volume: 4012,
    delta: 0.03941921300000217,
    time: '2019-10-22 10:36:00',
  },
  {
    volume: 3882,
    delta: -0.03941921300000217,
    time: '2019-10-22 10:37:00',
  },
  {
    volume: 4611,
    delta: 0,
    time: '2019-10-22 10:38:00',
  },
  {
    volume: 3706,
    delta: -0.10840283499999259,
    time: '2019-10-22 10:39:00',
  },
  {
    volume: 1963,
    delta: 0.009854803999985506,
    time: '2019-10-22 10:40:00',
  },
  {
    volume: 1666,
    delta: 0.029564409000016667,
    time: '2019-10-22 10:41:00',
  },
  {
    volume: 1412,
    delta: 0,
    time: '2019-10-22 10:42:00',
  },
  {
    volume: 930,
    delta: 0.009854802999996082,
    time: '2019-10-22 10:43:00',
  },
  {
    volume: 2094,
    delta: 0.1182576389999781,
    time: '2019-10-22 10:44:00',
  },
  {
    volume: 1889,
    delta: 0.019709606000020585,
    time: '2019-10-22 10:45:00',
  },
  {
    volume: 2320,
    delta: -0.07883842600000435,
    time: '2019-10-22 10:46:00',
  },
  {
    volume: 6953,
    delta: 0.009854803999985506,
    time: '2019-10-22 10:47:00',
  },
  {
    volume: 2873,
    delta: -0.009854803999985506,
    time: '2019-10-22 10:48:00',
  },
  {
    volume: 2370,
    delta: 0,
    time: '2019-10-22 10:49:00',
  },
  {
    volume: 633,
    delta: 0.03646277199999304,
    time: '2019-10-22 10:50:00',
  },
  {
    volume: 820,
    delta: -0.006898361999986946,
    time: '2019-10-22 10:51:00',
  },
  {
    volume: 3306,
    delta: 0.02956440999997767,
    time: '2019-10-22 10:52:00',
  },
  {
    volume: 1933,
    delta: 0.04927401500000883,
    time: '2019-10-22 10:53:00',
  },
  {
    volume: 2003,
    delta: -0.05912881899999434,
    time: '2019-10-22 10:54:00',
  },
  {
    volume: 2056,
    delta: -0.029564408999988245,
    time: '2019-10-22 10:55:00',
  },
  {
    volume: 2802,
    delta: 0.009854802999996082,
    time: '2019-10-22 10:56:00',
  },
  {
    volume: 3237,
    delta: -0.05912881900002276,
    time: '2019-10-22 10:57:00',
  },
  {
    volume: 2994,
    delta: -0.05912881899999434,
    time: '2019-10-22 10:58:00',
  },
  {
    volume: 2233,
    delta: 0,
    time: '2019-10-22 10:59:00',
  },
  {
    volume: 2634,
    delta: 0.03941921200001275,
    time: '2019-10-22 11:00:00',
  },
  {
    volume: 2165,
    delta: 0.02956441000000609,
    time: '2019-10-22 11:01:00',
  },
  {
    volume: 2542,
    delta: 0,
    time: '2019-10-22 11:02:00',
  },
  {
    volume: 1835,
    delta: 0.11825763799998867,
    time: '2019-10-22 11:03:00',
  },
  {
    volume: 1986,
    delta: 0.1281124420000026,
    time: '2019-10-22 11:04:00',
  },
  {
    volume: 869,
    delta: -0.06898362300000827,
    time: '2019-10-22 11:06:00',
  },
  {
    volume: 1380,
    delta: 0.034491811999998845,
    time: '2019-10-22 11:07:00',
  },
  {
    volume: 522,
    delta: 0.054201417000001584,
    time: '2019-10-22 11:08:00',
  },
  {
    volume: 1430,
    delta: -0.02956441000000609,
    time: '2019-10-22 11:09:00',
  },
  {
    volume: 2355,
    delta: 0.049274015999998255,
    time: '2019-10-22 11:10:00',
  },
  {
    volume: 2112,
    delta: 0.02956441000000609,
    time: '2019-10-22 11:11:00',
  },
  {
    volume: 1062,
    delta: -0.0443466140000055,
    time: '2019-10-22 11:12:00',
  },
  {
    volume: 1154,
    delta: 0.10347543299999984,
    time: '2019-10-22 11:13:00',
  },
  {
    volume: 442,
    delta: -0.06405622099998709,
    time: '2019-10-22 11:14:00',
  },
  {
    volume: 3329,
    delta: -0.11333023599999592,
    time: '2019-10-22 11:15:00',
  },
  {
    volume: 8666,
    delta: -0.06454896100001406,
    time: '2019-10-22 11:16:00',
  },
  {
    volume: 1307,
    delta: -0.042966941999992514,
    time: '2019-10-22 11:17:00',
  },
  {
    volume: 14068,
    delta: 0.08780629599999656,
    time: '2019-10-22 11:18:00',
  },
  {
    volume: 2975,
    delta: 0.009854804000013928,
    time: '2019-10-22 11:19:00',
  },
  {
    volume: 834,
    delta: 0.08869322799998258,
    time: '2019-10-22 11:20:00',
  },
  {
    volume: 402,
    delta: 0.009854802999996082,
    time: '2019-10-22 11:21:00',
  },
  {
    volume: 1845,
    delta: -0.05912881899999434,
    time: '2019-10-22 11:22:00',
  },
  {
    volume: 3415,
    delta: 0.13796724499999868,
    time: '2019-10-22 11:23:00',
  },
  {
    volume: 2355,
    delta: -0.03941921300000217,
    time: '2019-10-22 11:24:00',
  },
  {
    volume: 1879,
    delta: 0.03941921300000217,
    time: '2019-10-22 11:25:00',
  },
  {
    volume: 974,
    delta: 0.03449181100000942,
    time: '2019-10-22 11:26:00',
  },
  {
    volume: 2233,
    delta: -0.0443466140000055,
    time: '2019-10-22 11:27:00',
  },
  {
    volume: 1614,
    delta: 0.009854802999996082,
    time: '2019-10-22 11:28:00',
  },
  {
    volume: 8313,
    delta: -0.009854802999996082,
    time: '2019-10-22 11:29:00',
  },
  {
    volume: 3768,
    delta: 0.1182576380000171,
    time: '2019-10-22 11:30:00',
  },
  {
    volume: 2955,
    delta: -0.13796724499999868,
    time: '2019-10-22 11:31:00',
  },
  {
    volume: 4301,
    delta: -0.10840283500002101,
    time: '2019-10-22 11:32:00',
  },
  {
    volume: 819,
    delta: 0.01970960700001001,
    time: '2019-10-22 11:34:00',
  },
  {
    volume: 2690,
    delta: 0.1970960630000036,
    time: '2019-10-22 11:35:00',
  },
  {
    volume: 655,
    delta: -0.05912881899999434,
    time: '2019-10-22 11:36:00',
  },
  {
    volume: 567,
    delta: 0.049274015999998255,
    time: '2019-10-22 11:37:00',
  },
  {
    volume: 371,
    delta: -0.019709606000020585,
    time: '2019-10-22 11:38:00',
  },
  {
    volume: 437,
    delta: 0.1478220480000232,
    time: '2019-10-22 11:39:00',
  },
  {
    volume: 2276,
    delta: -0.06405622100001551,
    time: '2019-10-22 11:40:00',
  },
  {
    volume: 2134,
    delta: 0.009854802999996082,
    time: '2019-10-22 11:41:00',
  },
  {
    volume: 879,
    delta: 0.02463700800001334,
    time: '2019-10-22 11:42:00',
  },
  {
    volume: 1473,
    delta: -0.08869322900000043,
    time: '2019-10-22 11:43:00',
  },
  {
    volume: 3184,
    delta: -0.07883842500001492,
    time: '2019-10-22 11:44:00',
  },
  {
    volume: 495,
    delta: 0.049274015999998255,
    time: '2019-10-22 11:45:00',
  },
  {
    volume: 1670,
    delta: 0.035575839000017595,
    time: '2019-10-22 11:46:00',
  },
  {
    volume: 143,
    delta: 0.0826817989999995,
    time: '2019-10-22 11:47:00',
  },
  {
    volume: 160177,
    delta: -0.049274015999998255,
    time: '2019-10-22 11:48:00',
  },
  {
    volume: 1732,
    delta: 0.11825763799998867,
    time: '2019-10-22 11:49:00',
  },
  {
    volume: 1195,
    delta: 0.009854804000013928,
    time: '2019-10-22 11:50:00',
  },
  {
    volume: 235,
    delta: 0.019709605999992164,
    time: '2019-10-22 11:51:00',
  },
  {
    volume: 2771,
    delta: 0.009854802999996082,
    time: '2019-10-22 11:52:00',
  },
  {
    volume: 802,
    delta: -0.03449181100000942,
    time: '2019-10-22 11:53:00',
  },
  {
    volume: 820,
    delta: 0.06898362200001884,
    time: '2019-10-22 11:54:00',
  },
  {
    volume: 2601,
    delta: -0.02463700800001334,
    time: '2019-10-22 11:55:00',
  },
  {
    volume: 744,
    delta: 0.009854802999996082,
    time: '2019-10-22 11:56:00',
  },
  {
    volume: 616,
    delta: 0.06898362300000827,
    time: '2019-10-22 11:57:00',
  },
  {
    volume: 1891,
    delta: 0.049274015999998255,
    time: '2019-10-22 11:58:00',
  },
  {
    volume: 1810,
    delta: -0.009854803999985506,
    time: '2019-10-22 11:59:00',
  },
  {
    volume: 1566,
    delta: -0.029564409000016667,
    time: '2019-10-22 12:00:00',
  },
  {
    volume: 2050,
    delta: -0.009854802999996082,
    time: '2019-10-22 12:01:00',
  },
  {
    volume: 800,
    delta: -0.009854802999996082,
    time: '2019-10-22 12:03:00',
  },
  {
    volume: 2665,
    delta: -0.02463700800001334,
    time: '2019-10-22 12:04:00',
  },
  {
    volume: 862,
    delta: -0.014782204999988835,
    time: '2019-10-22 12:06:00',
  },
  {
    volume: 1863,
    delta: 0,
    time: '2019-10-22 12:07:00',
  },
  {
    volume: 1750,
    delta: 0.019709605999992164,
    time: '2019-10-22 12:08:00',
  },
  {
    volume: 1105,
    delta: -0.0443466140000055,
    time: '2019-10-22 12:09:00',
  },
  {
    volume: 918,
    delta: -0.034491810999981,
    time: '2019-10-22 12:10:00',
  },
  {
    volume: 1297,
    delta: -0.009854802999996082,
    time: '2019-10-22 12:12:00',
  },
  {
    volume: 1119,
    delta: -0.014782205000017257,
    time: '2019-10-22 12:13:00',
  },
  {
    volume: 139,
    delta: -0.024637007999984917,
    time: '2019-10-22 12:14:00',
  },
  {
    volume: 2250,
    delta: 0.014782204999988835,
    time: '2019-10-22 12:16:00',
  },
  {
    volume: 3296,
    delta: -0.04434661499999493,
    time: '2019-10-22 12:17:00',
  },
  {
    volume: 2295,
    delta: -0.009854802999996082,
    time: '2019-10-22 12:18:00',
  },
  {
    volume: 2351,
    delta: 0,
    time: '2019-10-22 12:19:00',
  },
  {
    volume: 927,
    delta: 0.009854802999996082,
    time: '2019-10-22 12:20:00',
  },
  {
    volume: 352,
    delta: -0.029564409000016667,
    time: '2019-10-22 12:21:00',
  },
  {
    volume: 2000,
    delta: 0.03449181100000942,
    time: '2019-10-22 12:22:00',
  },
  {
    volume: 2087,
    delta: 0.03449181100000942,
    time: '2019-10-22 12:23:00',
  },
  {
    volume: 3703,
    delta: 0,
    time: '2019-10-22 12:24:00',
  },
  {
    volume: 836,
    delta: 0,
    time: '2019-10-22 12:25:00',
  },
  {
    volume: 3062,
    delta: 0,
    time: '2019-10-22 12:26:00',
  },
  {
    volume: 921,
    delta: -0.02956441000000609,
    time: '2019-10-22 12:27:00',
  },
  {
    volume: 724,
    delta: -0.009854802999996082,
    time: '2019-10-22 12:28:00',
  },
  {
    volume: 504,
    delta: 0.009854802999996082,
    time: '2019-10-22 12:29:00',
  },
  {
    volume: 1282,
    delta: 0.02956441000000609,
    time: '2019-10-22 12:30:00',
  },
  {
    volume: 964,
    delta: 0.019709605999992164,
    time: '2019-10-22 12:31:00',
  },
  {
    volume: 1674,
    delta: -0.03222520599999257,
    time: '2019-10-22 12:32:00',
  },
  {
    volume: 2383,
    delta: -0.007194005999991759,
    time: '2019-10-22 12:33:00',
  },
  {
    volume: 246,
    delta: 0.019709605999992164,
    time: '2019-10-22 12:34:00',
  },
  {
    volume: 603,
    delta: 0.0788384249999865,
    time: '2019-10-22 12:35:00',
  },
  {
    volume: 130,
    delta: -0.029564408999988245,
    time: '2019-10-22 12:36:00',
  },
  {
    volume: 1077,
    delta: 0.019709605999992164,
    time: '2019-10-22 12:37:00',
  },
  {
    volume: 259,
    delta: -0.009854802999996082,
    time: '2019-10-22 12:38:00',
  },
  {
    volume: 191,
    delta: 0.06898362199999042,
    time: '2019-10-22 12:39:00',
  },
  {
    volume: 2861,
    delta: -0.03941921199998433,
    time: '2019-10-22 12:40:00',
  },
  {
    volume: 1209,
    delta: -0.009854804000013928,
    time: '2019-10-22 12:41:00',
  },
  {
    volume: 731,
    delta: 0.03941921300000217,
    time: '2019-10-22 12:42:00',
  },
  {
    volume: 104,
    delta: -0.049274015999998255,
    time: '2019-10-22 12:43:00',
  },
  {
    volume: 1266,
    delta: -0.029564408999988245,
    time: '2019-10-22 12:44:00',
  },
  {
    volume: 109,
    delta: 0,
    time: '2019-10-22 12:45:00',
  },
  {
    volume: 201,
    delta: 0.019709605999992164,
    time: '2019-10-22 12:46:00',
  },
  {
    volume: 1321,
    delta: 0.009854802999996082,
    time: '2019-10-22 12:48:00',
  },
  {
    volume: 764,
    delta: -0.049274015999998255,
    time: '2019-10-22 12:49:00',
  },
  {
    volume: 1153,
    delta: 0.049274015999998255,
    time: '2019-10-22 12:50:00',
  },
  {
    volume: 148,
    delta: -0.029564408999988245,
    time: '2019-10-22 12:51:00',
  },
  {
    volume: 2558,
    delta: 0.01478220399999941,
    time: '2019-10-22 12:52:00',
  },
  {
    volume: 192,
    delta: -0.12318503900002042,
    time: '2019-10-22 12:53:00',
  },
  {
    volume: 424,
    delta: 0.009854803000024503,
    time: '2019-10-22 12:54:00',
  },
  {
    volume: 938,
    delta: 0.009854802999996082,
    time: '2019-10-22 12:55:00',
  },
  {
    volume: 317,
    delta: -0.02956441000000609,
    time: '2019-10-22 12:56:00',
  },
  {
    volume: 1142,
    delta: -0.029564408999988245,
    time: '2019-10-22 12:57:00',
  },
  {
    volume: 482,
    delta: -0.007883843000001889,
    time: '2019-10-22 12:58:00',
  },
  {
    volume: 349,
    delta: -0.021680567000004203,
    time: '2019-10-22 12:59:00',
  },
  {
    volume: 1440,
    delta: 0.009854803999985506,
    time: '2019-10-22 13:00:00',
  },
  {
    volume: 200,
    delta: 0,
    time: '2019-10-22 13:01:00',
  },
  {
    volume: 1245,
    delta: 0.04927401500000883,
    time: '2019-10-22 13:02:00',
  },
  {
    volume: 1017,
    delta: 0.03941921300000217,
    time: '2019-10-22 13:03:00',
  },
  {
    volume: 2065,
    delta: -0.029564409000016667,
    time: '2019-10-22 13:04:00',
  },
  {
    volume: 446,
    delta: 0,
    time: '2019-10-22 13:06:00',
  },
  {
    volume: 445,
    delta: 0.03941921200001275,
    time: '2019-10-22 13:07:00',
  },
  {
    volume: 189,
    delta: 0.01970960700001001,
    time: '2019-10-22 13:08:00',
  },
  {
    volume: 646,
    delta: 0.009854802999996082,
    time: '2019-10-22 13:09:00',
  },
  {
    volume: 137,
    delta: -0.009854802999996082,
    time: '2019-10-22 13:10:00',
  },
  {
    volume: 1734,
    delta: 0.009854802999996082,
    time: '2019-10-22 13:11:00',
  },
  {
    volume: 2100,
    delta: 0.014782204999988835,
    time: '2019-10-22 13:12:00',
  },
  {
    volume: 142,
    delta: -0.034491810999981,
    time: '2019-10-22 13:13:00',
  },
  {
    volume: 1094,
    delta: 0.009854802999996082,
    time: '2019-10-22 13:14:00',
  },
  {
    volume: 2433,
    delta: 0.009854802999996082,
    time: '2019-10-22 13:15:00',
  },
  {
    volume: 517,
    delta: -0.009854802999996082,
    time: '2019-10-22 13:16:00',
  },
  {
    volume: 1465,
    delta: -0.009854802999996082,
    time: '2019-10-22 13:17:00',
  },
  {
    volume: 698,
    delta: 0.06898362199999042,
    time: '2019-10-22 13:18:00',
  },
  {
    volume: 2241,
    delta: -0.009854802999996082,
    time: '2019-10-22 13:19:00',
  },
  {
    volume: 539,
    delta: 0.019709605999992164,
    time: '2019-10-22 13:20:00',
  },
  {
    volume: 1165,
    delta: -0.049274015999998255,
    time: '2019-10-22 13:21:00',
  },
  {
    volume: 716,
    delta: 0.01970960700001001,
    time: '2019-10-22 13:22:00',
  },
  {
    volume: 708,
    delta: -0.009854804000013928,
    time: '2019-10-22 13:23:00',
  },
  {
    volume: 426,
    delta: 0.009854804000013928,
    time: '2019-10-22 13:24:00',
  },
  {
    volume: 1412,
    delta: 0.04434661399997708,
    time: '2019-10-22 13:25:00',
  },
  {
    volume: 2340,
    delta: -0.05420141799999101,
    time: '2019-10-22 13:26:00',
  },
  {
    volume: 1974,
    delta: -0.009854802999996082,
    time: '2019-10-22 13:27:00',
  },
  {
    volume: 200,
    delta: 0.014782204999988835,
    time: '2019-10-22 13:28:00',
  },
  {
    volume: 915,
    delta: 0.054201417000001584,
    time: '2019-10-22 13:29:00',
  },
  {
    volume: 1341,
    delta: 0.009854804000013928,
    time: '2019-10-22 13:30:00',
  },
  {
    volume: 1167,
    delta: 0.009854802999996082,
    time: '2019-10-22 13:31:00',
  },
  {
    volume: 458,
    delta: 0.019709605999992164,
    time: '2019-10-22 13:32:00',
  },
  {
    volume: 810,
    delta: -0.029564408999988245,
    time: '2019-10-22 13:33:00',
  },
  {
    volume: 1959,
    delta: 0.024637007999984917,
    time: '2019-10-22 13:34:00',
  },
  {
    volume: 2218,
    delta: -0.014782204999988835,
    time: '2019-10-22 13:35:00',
  },
  {
    volume: 2528,
    delta: 0.03941921300000217,
    time: '2019-10-22 13:36:00',
  },
  {
    volume: 2772,
    delta: -0.00975625600000285,
    time: '2019-10-22 13:37:00',
  },
  {
    volume: 1388,
    delta: -0.024735555999995995,
    time: '2019-10-22 13:38:00',
  },
  {
    volume: 3513,
    delta: -0.06405621999999767,
    time: '2019-10-22 13:39:00',
  },
  {
    volume: 1843,
    delta: 0.019709605999992164,
    time: '2019-10-22 13:40:00',
  },
  {
    volume: 776,
    delta: 0.019709605999992164,
    time: '2019-10-22 13:41:00',
  },
  {
    volume: 758,
    delta: 0.02463700800001334,
    time: '2019-10-22 13:42:00',
  },
  {
    volume: 2014,
    delta: 0.004927401999992753,
    time: '2019-10-22 13:43:00',
  },
  {
    volume: 1729,
    delta: 0.009854802999996082,
    time: '2019-10-22 13:44:00',
  },
  {
    volume: 1275,
    delta: 0.009854802999996082,
    time: '2019-10-22 13:45:00',
  },
  {
    volume: 2046,
    delta: -0.009854802999996082,
    time: '2019-10-22 13:46:00',
  },
  {
    volume: 2322,
    delta: 0,
    time: '2019-10-22 13:47:00',
  },
  {
    volume: 1761,
    delta: 0.004927401999992753,
    time: '2019-10-22 13:48:00',
  },
  {
    volume: 809,
    delta: -0.004927401999992753,
    time: '2019-10-22 13:49:00',
  },
  {
    volume: 2862,
    delta: 0.049274015999998255,
    time: '2019-10-22 13:50:00',
  },
  {
    volume: 2191,
    delta: 0,
    time: '2019-10-22 13:51:00',
  },
  {
    volume: 3065,
    delta: 0.014782205000017257,
    time: '2019-10-22 13:52:00',
  },
  {
    volume: 2037,
    delta: 0.014782204999988835,
    time: '2019-10-22 13:53:00',
  },
  {
    volume: 1884,
    delta: 0.009854802999996082,
    time: '2019-10-22 13:54:00',
  },
  {
    volume: 2948,
    delta: 0.019709605999992164,
    time: '2019-10-22 13:55:00',
  },
  {
    volume: 1679,
    delta: 0.01970960700001001,
    time: '2019-10-22 13:56:00',
  },
  {
    volume: 2348,
    delta: -0.03941921300000217,
    time: '2019-10-22 13:57:00',
  },
  {
    volume: 880,
    delta: 0.03941921300000217,
    time: '2019-10-22 13:58:00',
  },
  {
    volume: 1379,
    delta: -0.009854803999985506,
    time: '2019-10-22 13:59:00',
  },
  {
    volume: 1376,
    delta: -0.019709606000020585,
    time: '2019-10-22 14:00:00',
  },
  {
    volume: 1813,
    delta: -0.14782204799999477,
    time: '2019-10-22 14:01:00',
  },
  {
    volume: 4089,
    delta: 0.07883842600000435,
    time: '2019-10-22 14:02:00',
  },
  {
    volume: 1114,
    delta: -0.01970960700001001,
    time: '2019-10-22 14:04:00',
  },
  {
    volume: 163,
    delta: -0.009362062999997534,
    time: '2019-10-22 14:05:00',
  },
  {
    volume: 468,
    delta: -0.03991195300000072,
    time: '2019-10-22 14:06:00',
  },
  {
    volume: 2144,
    delta: -0.029564408999988245,
    time: '2019-10-22 14:07:00',
  },
  {
    volume: 2477,
    delta: 0.029564408999988245,
    time: '2019-10-22 14:08:00',
  },
  {
    volume: 4297,
    delta: 0.009854804000013928,
    time: '2019-10-22 14:09:00',
  },
  {
    volume: 745,
    delta: 0.009854802999996082,
    time: '2019-10-22 14:10:00',
  },
  {
    volume: 1199,
    delta: -0.03941921300000217,
    time: '2019-10-22 14:11:00',
  },
  {
    volume: 1321,
    delta: 0.03941921300000217,
    time: '2019-10-22 14:12:00',
  },
  {
    volume: 1323,
    delta: -0.02463700800001334,
    time: '2019-10-22 14:13:00',
  },
  {
    volume: 4133,
    delta: -0.05420141799999101,
    time: '2019-10-22 14:14:00',
  },
  {
    volume: 1012,
    delta: 0.014782204999988835,
    time: '2019-10-22 14:15:00',
  },
  {
    volume: 395,
    delta: -0.04434661399997708,
    time: '2019-10-22 14:16:00',
  },
  {
    volume: 2584,
    delta: 0.029564408999988245,
    time: '2019-10-22 14:17:00',
  },
  {
    volume: 1354,
    delta: 0.02956441000000609,
    time: '2019-10-22 14:18:00',
  },
  {
    volume: 2330,
    delta: -0.10840283499999259,
    time: '2019-10-22 14:19:00',
  },
  {
    volume: 1455,
    delta: 0,
    time: '2019-10-22 14:20:00',
  },
  {
    volume: 785,
    delta: 0.10840283499999259,
    time: '2019-10-22 14:21:00',
  },
  {
    volume: 817,
    delta: 0.15767685099999085,
    time: '2019-10-22 14:22:00',
  },
  {
    volume: 586,
    delta: -0.03941921300000217,
    time: '2019-10-22 14:23:00',
  },
  {
    volume: 1959,
    delta: 0.009854802999996082,
    time: '2019-10-22 14:24:00',
  },
  {
    volume: 2886,
    delta: -0.019709605999992164,
    time: '2019-10-22 14:25:00',
  },
  {
    volume: 868,
    delta: 0.019709605999992164,
    time: '2019-10-22 14:26:00',
  },
  {
    volume: 1030,
    delta: 0.049274015999998255,
    time: '2019-10-22 14:27:00',
  },
  {
    volume: 1756,
    delta: 0.08869322900000043,
    time: '2019-10-22 14:28:00',
  },
  {
    volume: 1852,
    delta: 0.004927402000021175,
    time: '2019-10-22 14:29:00',
  },
  {
    volume: 2015,
    delta: 0.004927401000003329,
    time: '2019-10-22 14:30:00',
  },
  {
    volume: 3110,
    delta: 0.17245905599997968,
    time: '2019-10-22 14:31:00',
  },
  {
    volume: 682,
    delta: 0.03449181100000942,
    time: '2019-10-22 14:32:00',
  },
  {
    volume: 10924,
    delta: 0.009854802999996082,
    time: '2019-10-22 14:33:00',
  },
  {
    volume: 3981,
    delta: 0,
    time: '2019-10-22 14:34:00',
  },
  {
    volume: 2499,
    delta: 0.049274015999998255,
    time: '2019-10-22 14:35:00',
  },
  {
    volume: 1141,
    delta: -0.08711646000000428,
    time: '2019-10-22 14:36:00',
  },
  {
    volume: 1511,
    delta: -0.0015767689999961476,
    time: '2019-10-22 14:37:00',
  },
  {
    volume: 2477,
    delta: -0.009854802999996082,
    time: '2019-10-22 14:38:00',
  },
  {
    volume: 1651,
    delta: -0.029564408999988245,
    time: '2019-10-22 14:39:00',
  },
  {
    volume: 1533,
    delta: 0.08869322799998258,
    time: '2019-10-22 14:40:00',
  },
  {
    volume: 137,
    delta: 0.004927402000021175,
    time: '2019-10-22 14:41:00',
  },
  {
    volume: 1290,
    delta: 0.014782204999988835,
    time: '2019-10-22 14:42:00',
  },
  {
    volume: 794,
    delta: 0.0788384249999865,
    time: '2019-10-22 14:43:00',
  },
  {
    volume: 2002,
    delta: -0.019709605999992164,
    time: '2019-10-22 14:44:00',
  },
  {
    volume: 1542,
    delta: 0.07883842500001492,
    time: '2019-10-22 14:45:00',
  },
  {
    volume: 1128,
    delta: 0.019709606999981588,
    time: '2019-10-22 14:46:00',
  },
  {
    volume: 1572,
    delta: 0.049274015999998255,
    time: '2019-10-22 14:47:00',
  },
  {
    volume: 513,
    delta: 0.12811244100001318,
    time: '2019-10-22 14:48:00',
  },
  {
    volume: 555,
    delta: -0.02956441000000609,
    time: '2019-10-22 14:49:00',
  },
  {
    volume: 2361,
    delta: 0.06405622099998709,
    time: '2019-10-22 14:50:00',
  },
  {
    volume: 1695,
    delta: 0.08376582700000768,
    time: '2019-10-22 14:51:00',
  },
  {
    volume: 1753,
    delta: -0.004927401000003329,
    time: '2019-10-22 14:52:00',
  },
  {
    volume: 4430,
    delta: -0.10347543399998926,
    time: '2019-10-22 14:53:00',
  },
  {
    volume: 4404,
    delta: 0.05912881899999434,
    time: '2019-10-22 14:54:00',
  },
  {
    volume: 4341,
    delta: -0.11825763799998867,
    time: '2019-10-22 14:55:00',
  },
  {
    volume: 4032,
    delta: 0.02956441000000609,
    time: '2019-10-22 14:56:00',
  },
  {
    volume: 1046,
    delta: 0.05912881899999434,
    time: '2019-10-22 14:57:00',
  },
  {
    volume: 889,
    delta: 0.029564408999988245,
    time: '2019-10-22 14:58:00',
  },
  {
    volume: 5817,
    delta: 0.06898362300000827,
    time: '2019-10-22 14:59:00',
  },
  {
    volume: 2403,
    delta: -0.0739110240000116,
    time: '2019-10-22 15:00:00',
  },
  {
    volume: 2183,
    delta: 0.09362063000000376,
    time: '2019-10-22 15:01:00',
  },
  {
    volume: 862,
    delta: -0.009854802999996082,
    time: '2019-10-22 15:02:00',
  },
  {
    volume: 2993,
    delta: 0.03941921300000217,
    time: '2019-10-22 15:03:00',
  },
  {
    volume: 525,
    delta: 0.09854803100000709,
    time: '2019-10-22 15:04:00',
  },
  {
    volume: 2844,
    delta: 0.034886003999986315,
    time: '2019-10-22 15:05:00',
  },
  {
    volume: 2433,
    delta: -0.09894222399998398,
    time: '2019-10-22 15:06:00',
  },
  {
    volume: 2486,
    delta: 0.04434661399997708,
    time: '2019-10-22 15:07:00',
  },
  {
    volume: 3519,
    delta: -0.19216866200000027,
    time: '2019-10-22 15:08:00',
  },
  {
    volume: 13204,
    delta: 0.06405622100001551,
    time: '2019-10-22 15:09:00',
  },
  {
    volume: 3120,
    delta: 0.07391102399998317,
    time: '2019-10-22 15:10:00',
  },
  {
    volume: 852,
    delta: -0.07391102399998317,
    time: '2019-10-22 15:11:00',
  },
  {
    volume: 9677,
    delta: 0.06898362199999042,
    time: '2019-10-22 15:12:00',
  },
  {
    volume: 2440,
    delta: -0.03941921300000217,
    time: '2019-10-22 15:13:00',
  },
  {
    volume: 4415,
    delta: 0.049274015999998255,
    time: '2019-10-22 15:14:00',
  },
  {
    volume: 3221,
    delta: -0.019709605999992164,
    time: '2019-10-22 15:15:00',
  },
  {
    volume: 4532,
    delta: 0.019709605999992164,
    time: '2019-10-22 15:16:00',
  },
  {
    volume: 4141,
    delta: 0.02956441000000609,
    time: '2019-10-22 15:17:00',
  },
  {
    volume: 4803,
    delta: -0.07883842600000435,
    time: '2019-10-22 15:18:00',
  },
  {
    volume: 4280,
    delta: 0.009854802999996082,
    time: '2019-10-22 15:19:00',
  },
  {
    volume: 1142,
    delta: 0.009854804000013928,
    time: '2019-10-22 15:20:00',
  },
  {
    volume: 838,
    delta: -0.034491811999998845,
    time: '2019-10-22 15:21:00',
  },
  {
    volume: 3865,
    delta: -0.1527494489999981,
    time: '2019-10-22 15:22:00',
  },
  {
    volume: 4394,
    delta: 0.03941921300000217,
    time: '2019-10-22 15:23:00',
  },
  {
    volume: 920,
    delta: 0,
    time: '2019-10-22 15:24:00',
  },
  {
    volume: 1788,
    delta: -0.009854802999996082,
    time: '2019-10-22 15:25:00',
  },
  {
    volume: 1767,
    delta: 0,
    time: '2019-10-22 15:26:00',
  },
  {
    volume: 612,
    delta: -0.02956441000000609,
    time: '2019-10-22 15:27:00',
  },
  {
    volume: 968,
    delta: 0.02956441000000609,
    time: '2019-10-22 15:28:00',
  },
  {
    volume: 2952,
    delta: -0.009854804000013928,
    time: '2019-10-22 15:29:00',
  },
  {
    volume: 1207,
    delta: -0.09854803100000709,
    time: '2019-10-22 15:30:00',
  },
  {
    volume: 2717,
    delta: 0.009854802999996082,
    time: '2019-10-22 15:31:00',
  },
  {
    volume: 2245,
    delta: 0,
    time: '2019-10-22 15:32:00',
  },
  {
    volume: 791,
    delta: 0.03449181100000942,
    time: '2019-10-22 15:33:00',
  },
  {
    volume: 2555,
    delta: 0.004927401000003329,
    time: '2019-10-22 15:34:00',
  },
  {
    volume: 1661,
    delta: -0.009854802999996082,
    time: '2019-10-22 15:35:00',
  },
  {
    volume: 4373,
    delta: -0.10840283499999259,
    time: '2019-10-22 15:36:00',
  },
  {
    volume: 8616,
    delta: -0.009854802999996082,
    time: '2019-10-22 15:37:00',
  },
  {
    volume: 906,
    delta: 0.03941921299997375,
    time: '2019-10-22 15:38:00',
  },
  {
    volume: 2874,
    delta: 0.019709606000020585,
    time: '2019-10-22 15:39:00',
  },
  {
    volume: 5481,
    delta: -0.009854802999996082,
    time: '2019-10-22 15:40:00',
  },
  {
    volume: 3745,
    delta: 0.004927401999992753,
    time: '2019-10-22 15:41:00',
  },
  {
    volume: 4129,
    delta: 0.034491810999981,
    time: '2019-10-22 15:42:00',
  },
  {
    volume: 2490,
    delta: 0.004927401000003329,
    time: '2019-10-22 15:43:00',
  },
  {
    volume: 809,
    delta: 0.02463700800001334,
    time: '2019-10-22 15:44:00',
  },
  {
    volume: 4094,
    delta: 0.08869322900000043,
    time: '2019-10-22 15:45:00',
  },
  {
    volume: 3572,
    delta: 0.009854802999996082,
    time: '2019-10-22 15:46:00',
  },
  {
    volume: 3315,
    delta: 0.04730305500001464,
    time: '2019-10-22 15:47:00',
  },
  {
    volume: 3347,
    delta: 0.03646277199999304,
    time: '2019-10-22 15:48:00',
  },
  {
    volume: 2056,
    delta: -0.03449181100000942,
    time: '2019-10-22 15:49:00',
  },
  {
    volume: 3194,
    delta: -0.08869322900000043,
    time: '2019-10-22 15:50:00',
  },
  {
    volume: 2585,
    delta: 0.05912882000001218,
    time: '2019-10-22 15:51:00',
  },
  {
    volume: 7788,
    delta: 0.01478220399999941,
    time: '2019-10-22 15:52:00',
  },
  {
    volume: 3505,
    delta: -0.054201417000001584,
    time: '2019-10-22 15:53:00',
  },
  {
    volume: 7326,
    delta: 0,
    time: '2019-10-22 15:54:00',
  },
  {
    volume: 6092,
    delta: -0.01970960700001001,
    time: '2019-10-22 15:55:00',
  },
  {
    volume: 3623,
    delta: 0.05912882000001218,
    time: '2019-10-22 15:56:00',
  },
  {
    volume: 6323,
    delta: -0.009854804000013928,
    time: '2019-10-22 15:57:00',
  },
  {
    volume: 5306,
    delta: -0.009854802999996082,
    time: '2019-10-22 15:58:00',
  },
  {
    volume: 9816,
    delta: 0.06898362199999042,
    time: '2019-10-22 15:59:00',
  },
  {
    volume: 22339,
    delta: 0.009854804000013928,
    time: '2019-10-22 16:00:00',
  },
  {
    volume: 1744,
    delta: 0,
    time: '2019-10-22 16:03:00',
  },
];

/**
 * A Random Test-Brain, which creates orders as it pleases
 */
export class SzenarioBrain extends Brain {
  private alive = false;
  private agent: Readonly<Agent>;
  private marketService: Readonly<MarketService>;
  private logger = new Logger();

  private startDate = new Date(2019, 9, 22, 4, 51);
  private currentTime = timer(0, 1000);

  onAgentInit(agent: Readonly<Agent>): PromiseOrValue<void> {
    this.agent = agent;
  }

  onMarketInit(marketService: Readonly<MarketService>): PromiseOrValue<void> {
    this.marketService = marketService;
  }

  onData(data) {
    console.log('data', data)
  }

  animate(): PromiseOrValue<void> {
    this.alive = true;

    this.currentTime
      .pipe(
        takeWhile(_=>this.alive),
        map((time) => addMinutes(this.startDate, time)),
      )
      .subscribe(async (time) => {
        const datapoint = testDATA.find((d) => {
          return new Date(d.time).getTime() === time.getTime();
        });

        if(!datapoint) return

        //delta sind prozentpunkte
        const currentMarket = await this.marketService.onInformationAvailable
          .pipe(take(1))
          .toPromise();

        const target = currentMarket * (1 + datapoint.delta);
        console.log(currentMarket, target)

        const diff = target - currentMarket;
        const volume = datapoint.volume;
        //SELL Order
        this.marketService.placeOrder({
          stockCount: volume,
          aktenId: 'moon',
          price: target,
          type: OrderType.MARKET_ORDER,
          operation: OperationType.SELL
        });

        //Buy order
        this.marketService.placeOrder({
          stockCount: volume,
          aktenId: 'moon',
          price: target,
          type: OrderType.MARKET_ORDER,
          operation: OperationType.BUY
        });
      });
  }

  kill(): PromiseOrValue<void> {
    this.alive = false;
  }

  isAlive(): PromiseOrValue<boolean> {
    return this.alive;
  }
}
